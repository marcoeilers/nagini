import "./keydict_definition.vpr"

function custom__dict__(class_instance: Ref): Ref
    ensures custom__dict__inv(result) == class_instance

function custom__dict__inv(custom__dict__instance: Ref): Ref

method Parent___init__(self: Ref, x: Ref, y: Ref, z: Ref)
  requires self != null
  requires issubtype(typeof(self), Parent())
  requires issubtype(typeof(x), int())
  requires issubtype(typeof(y), int())
  requires issubtype(typeof(z), int())

  ensures issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0))
  ensures issubtype(int(), dict_arg(typeof(custom__dict__(self)), 1))
  ensures issubtype(typeof(custom__dict__(self)), dict(dict_arg(typeof(custom__dict__(self)), 0), dict_arg(typeof(custom__dict__(self)), 1)))

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(120))).keydict_val)
  ensures keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(120)))
  ensures keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(120))) == x

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(121))).keydict_val)
  ensures keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(121)))
  ensures keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(121))) == y

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(122))).keydict_val)
  ensures keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(122)))
  ensures keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(122))) == z 

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(100))).keydict_val)
  ensures !keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(100)))
{
  var custom_dict: Ref
  custom_dict := keydict___init__()
  assume (custom__dict__(self) == custom_dict)
  assume issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0))
  assume issubtype(object(), dict_arg(typeof(custom__dict__(self)), 1))

  assert keydict___len__(custom__dict__(self)) == 0
  keydict___setitem__(custom__dict__(self), seq_int_str___box__(Seq(120)), x)
  keydict___setitem__(custom__dict__(self), seq_int_str___box__(Seq(121)), y)
  keydict___setitem__(custom__dict__(self), seq_int_str___box__(Seq(122)), z)
}

method Child___init__(self: Ref, x: Ref, y: Ref, z: Ref)
  requires self != null
  requires issubtype(typeof(self), Child())
  requires issubtype(typeof(x), int())
  requires issubtype(typeof(y), int())
  requires issubtype(typeof(z), int())

  ensures issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0))
  ensures issubtype(int(), dict_arg(typeof(custom__dict__(self)), 1))
  ensures issubtype(typeof(custom__dict__(self)), dict(dict_arg(typeof(custom__dict__(self)), 0), dict_arg(typeof(custom__dict__(self)), 1)))

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(120))).keydict_val)
  ensures keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(120)))
  ensures keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(120))) == x

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(121))).keydict_val)
  ensures keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(121)))
  ensures keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(121))) == y

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(122))).keydict_val)
  ensures keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(122)))
  ensures keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(122))) == z 

  ensures acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(100))).keydict_val)
  ensures !keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(100)))
{
  var custom_dict: Ref
  custom_dict := keydict___init__()
  assume (custom__dict__(self) == custom_dict)
  assume issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0))
  assume issubtype(object(), dict_arg(typeof(custom__dict__(self)), 1))

  assert keydict___len__(custom__dict__(self)) == 0
  keydict___setitem__(custom__dict__(self), seq_int_str___box__(Seq(120)), x)
  keydict___setitem__(custom__dict__(self), seq_int_str___box__(Seq(121)), y)
  keydict___setitem__(custom__dict__(self), seq_int_str___box__(Seq(122)), z)
}

predicate Parent_pred_fam(self: Ref) {
  true &&
  (
    issubtype(typeof(self), Parent()) ==> (
      issubtype(typeof(custom__dict__(self)), dict(dict_arg(typeof(custom__dict__(self)), 0), dict_arg(typeof(custom__dict__(self)), 1))) &&
      issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0)) &&
      issubtype(int(), dict_arg(typeof(custom__dict__(self)), 1)) &&
      acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(120))).keydict_val, wildcard) &&
      keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(120))) &&
      issubtype(typeof(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(120)))), int()) &&
      int___gt__(int___unbox__(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(120)))), 0)
    )
  ) &&
  (
    issubtype(typeof(self), Child()) ==> (
      issubtype(typeof(custom__dict__(self)), dict(dict_arg(typeof(custom__dict__(self)), 0), dict_arg(typeof(custom__dict__(self)), 1))) &&
      issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0)) &&
      issubtype(int(), dict_arg(typeof(custom__dict__(self)), 1)) &&
      acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(121))).keydict_val, wildcard) &&
      keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(121))) &&
      issubtype(typeof(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(121)))), int()) &&
      int___gt__(int___unbox__(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(121)))), 0)
    )
  )
}

predicate Parent_pred_parent(self: Ref) {
  true &&
  Parent() == typeof(self) &&

  issubtype(typeof(custom__dict__(self)), dict(dict_arg(typeof(custom__dict__(self)), 0), dict_arg(typeof(custom__dict__(self)), 1))) &&
  issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0)) &&
  issubtype(int(), dict_arg(typeof(custom__dict__(self)), 1)) &&
  acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(122))).keydict_val, wildcard) &&
  keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(122))) &&
  issubtype(typeof(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(122)))), int()) &&
  int___gt__(int___unbox__(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(122)))), 0)
}

predicate Child_pred_child(self: Ref) {
  true && 
  Child() == typeof(self) &&

  issubtype(typeof(custom__dict__(self)), dict(dict_arg(typeof(custom__dict__(self)), 0), dict_arg(typeof(custom__dict__(self)), 1))) &&
  issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0)) &&
  issubtype(int(), dict_arg(typeof(custom__dict__(self)), 1)) &&
  acc(keydict___item__(custom__dict__(self), seq_int_str___box__(Seq(122))).keydict_val, wildcard) &&
  keydict___contains__(custom__dict__(self), seq_int_str___box__(Seq(122))) &&
  issubtype(typeof(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(122)))), int()) &&
  int___lt__(int___unbox__(keydict___getitem__(custom__dict__(self), seq_int_str___box__(Seq(122)))), 0)
}

function Parent_gethidden_parent(self: Ref, name: Ref): Ref
  requires issubtype(typeof(self), Parent())
  requires issubtype(typeof(name), dict_arg(typeof(custom__dict__(self)), 0))
  requires issubtype(typeof(custom__dict__(self)), dict(dict_arg(typeof(custom__dict__(self)), 0), dict_arg(typeof(custom__dict__(self)), 1)))
  requires issubtype(seq_int_str(), dict_arg(typeof(custom__dict__(self)), 0))
  requires issubtype(int(), dict_arg(typeof(custom__dict__(self)), 1))
  requires acc(keydict___item__(custom__dict__(self), name).keydict_val, wildcard)
{
  keydict___contains__(custom__dict__(self), name) ? 
    keydict___getitem__(custom__dict__(self), name) : 
    (Child() == typeof(self) ? 
      Child_getattr_child(self) :
      Parent_getattr_parent(self)
    )
}

function Parent_getattr_parent(self: Ref): Ref
  requires issubtype(typeof(self), Parent())
  ensures issubtype(typeof(result), int())
  ensures int___gt__(int___unbox__(result), 10)

function Child_getattr_child(self: Ref): Ref
  requires issubtype(typeof(self), Child())
  ensures issubtype(typeof(result), int())
  ensures int___gt__(int___unbox__(result), 20)

method my_func_1(c: Ref)
  requires issubtype(typeof(c), Child())
  requires acc(Parent_pred_fam(c), write)
  ensures acc(Parent_pred_fam(c), write)
{
  unfold acc(Parent_pred_fam(c), 1 / 2)
  assert int___gt__(int___unbox__(Parent_gethidden_parent(c, seq_int_str___box__(Seq(120)))), 0)
  assert int___gt__(int___unbox__(Parent_gethidden_parent(c, seq_int_str___box__(Seq(121)))), 0)
  fold acc(Parent_pred_fam(c), 1 / 2)
}

method my_func_2(p: Ref)
  requires issubtype(typeof(p), Parent())
  requires acc(Parent_pred_parent(p), write)
  ensures acc(Parent_pred_parent(p), write)
{
  unfold acc(Parent_pred_parent(p), 1 / 2)
  assert int___gt__(int___unbox__(Parent_gethidden_parent(p, seq_int_str___box__(Seq(122)))), 0)
  fold acc(Parent_pred_parent(p), 1 / 2)
}

method my_func_3(c: Ref)
  requires issubtype(typeof(c), Child())
  requires acc(Child_pred_child(c), write)
  ensures acc(Child_pred_child(c), write)
{
  unfold acc(Child_pred_child(c), 1 / 2)
  assert int___lt__(int___unbox__(Parent_gethidden_parent(c, seq_int_str___box__(Seq(122)))), 0)
  fold acc(Child_pred_child(c), 1 / 2)
}

method main()
{
  var p: Ref
  p := new()
  inhale typeof(p) == Parent()
  Parent___init__(p, __prim__int___box__(1), __prim__int___box__(1), __prim__int___box__(1))

  var c: Ref
  c := new()
  inhale typeof(c) == Child()
  Child___init__(c, __prim__int___box__(1), __prim__int___box__(1), __prim__int___box__(-1))

  fold acc(Parent_pred_fam(p), write)
  fold acc(Parent_pred_fam(c), write)
  fold acc(Parent_pred_parent(p), write)
  fold acc(Child_pred_child(c), write)

  // assert int___unbox__(Parent_gethidden_parent(Parent_res, seq_int_str___box__(Seq(120)))) > 0
  assert (unfolding acc(Parent_pred_fam(p), 1 / 2) in int___gt__(int___unbox__(Parent_gethidden_parent(p, seq_int_str___box__(Seq(120)))), 0))
  assert int___gt__(int___unbox__(Parent_gethidden_parent(p, seq_int_str___box__(Seq(100)))), 10)
  assert int___gt__(int___unbox__(Parent_gethidden_parent(c, seq_int_str___box__(Seq(100)))), 20)

  my_func_1(c)
  my_func_2(p)
  my_func_3(c)

  // assert 10 == 15   // sanity check
}